# Требования к обратному конвертеру DOCX → Markdown

## Назначение

Обратный конвертер предназначен для преобразования документов ЧТЗ из формата DOCX обратно в исходный Markdown с YAML-метаданными.

### Сценарии использования

1. **Конвертация исторических документов** — перевод существующих ЧТЗ в формат Markdown для версионирования в Git
2. **Синхронизация после внешнего редактирования** — обработка изменений, внесённых внешними пользователями в DOCX-файл
3. **Валидация round-trip** — проверка корректности конвертации Markdown → DOCX → Markdown

---

## Функциональные требования

### FR-01: Парсинг структуры DOCX

| ID | Требование |
|----|------------|
| FR-01.1 | Система должна читать файлы формата DOCX (Office Open XML) |
| FR-01.2 | Система должна извлекать текстовое содержимое из `word/document.xml` |
| FR-01.3 | Система должна распознавать стили абзацев (Heading 1-4, Normal, списки) |
| FR-01.4 | Система должна корректно обрабатывать вложенные структуры (списки внутри таблиц) |

### FR-02: Распознавание YAML-метаданных

| ID | Требование |
|----|------------|
| FR-02.1 | Система должна извлекать метаданные из титульной страницы документа |
| FR-02.2 | Обязательные поля: shortName, consultant.name, consultant.email, organization, createdDate |
| FR-02.3 | Опциональные поля: itSolutions, itSystems, processKT, processPDn |
| FR-02.4 | Система должна формировать корректный YAML front matter |

**Структура извлекаемых метаданных:**

```yaml
metadata:
  shortName: "Извлечённое название"
  consultant:
    name: "ФИО консультанта"
    email: "email@company.ru"
  organization: "Название организации"
  itSolutions:
    - "ИТ-решение 1"
  itSystems:
    - "ИТ-система 1"
  processKT: true/false
  processPDn: true/false
  createdDate: "DD.MM.YYYY"
```

### FR-03: Распознавание специальных таблиц

| ID | Тип таблицы | Признаки | Результат |
|----|-------------|----------|-----------|
| FR-03.1 | Таблица терминов | 2 колонки: "Термин", "Определение" | `:::terms` |
| FR-03.2 | Таблица изменений | 2 колонки: "Как есть", "Как будет" | `:::changes-table` |
| FR-03.3 | Функциональная таблица | Поля: Функция, Задача, Сценарий | `:::function-table{#id}` |
| FR-03.4 | Таблица ролей | Колонки: Роль, Описание, Права | Обычная Markdown-таблица |

**Пример распознавания функциональной таблицы:**

Входной DOCX содержит:
```
┌─────────────────────────────────────┐
│ • Функция: Название функции         │
│ • Задача: TASK-123                  │
│ • Ссылка: https://jira.example.com  │
├─────────────────────────────────────┤
│ Сценарий:                           │
│ 1. Шаг первый                       │
│ 2. Шаг второй                       │
└─────────────────────────────────────┘
```

Результат:
```markdown
:::function-table{#func-id}
function: Название функции
task: TASK-123
taskUrl: https://jira.example.com
scenario: |
  1. Шаг первый
  2. Шаг второй
:::
```

### FR-04: Распознавание структуры разделов

| ID | Требование |
|----|------------|
| FR-04.1 | Система должна распознавать заголовки по стилям (Heading 1, Heading 2, и т.д.) |
| FR-04.2 | Система должна идентифицировать 10 обязательных разделов ЧТЗ |
| FR-04.3 | Система должна сохранять иерархию подразделов |
| FR-04.4 | Заголовки "Таблица N. Название" должны преобразовываться в `#### Таблица N. Название` |

**10 обязательных разделов:**

1. Термины и определения
2. Исходные данные задания
3. Изменение функционала системы
4. Описание изменений в ИТ-системе
5. Описание изменений в интеграционных механизмах
6. Описание изменений, состава обрабатываемых ПДн
7. Входные формы
8. Выходные формы
9. Описание изменений в ролевой модели
10. Приложения

### FR-05: Извлечение изображений

| ID | Требование |
|----|------------|
| FR-05.1 | Система должна извлекать встроенные изображения из `word/media/` |
| FR-05.2 | Система должна сохранять изображения в указанную папку (по умолчанию `images/`) |
| FR-05.3 | Система должна генерировать уникальные имена файлов |
| FR-05.4 | Система должна формировать корректные Markdown-ссылки на изображения |
| FR-05.5 | Система должна сохранять атрибуты размера изображения (width) |

**Поддерживаемые форматы:** PNG, JPEG, GIF, EMF, WMF

### FR-06: Обработка форматирования текста

| ID | DOCX-элемент | Markdown |
|----|--------------|----------|
| FR-06.1 | `<w:b/>` (bold) | `**текст**` |
| FR-06.2 | `<w:i/>` (italic) | `*текст*` |
| FR-06.3 | `<w:u/>` (underline) | `<u>текст</u>` или игнорировать |
| FR-06.4 | Нумерованный список | `1. пункт` |
| FR-06.5 | Маркированный список | `- пункт` |
| FR-06.6 | Гиперссылка | `[текст](url)` |
| FR-06.7 | Разрыв страницы | Игнорировать |

### FR-07: Обработка примечаний

| ID | Требование |
|----|------------|
| FR-07.1 | Распознавание блоков с текстом "Внимание:" → `:::note{type="warning"}` |
| FR-07.2 | Распознавание блоков с текстом "Важно:" → `:::note{type="danger"}` |
| FR-07.3 | Распознавание блоков с текстом "Примечание:" → `:::note{type="info"}` |
| FR-07.4 | Распознавание по стилю абзаца (если есть специальный стиль Note/Warning) |

### FR-08: Извлечение истории версий

| ID | Требование |
|----|------------|
| FR-08.1 | Парсинг таблицы "История изменений документа" |
| FR-08.2 | Извлечение полей: version, date, comment, author |
| FR-08.3 | Формирование секции `history` в YAML |

### FR-09: Распознавание пустых разделов

| ID | Требование |
|----|------------|
| FR-09.1 | Текст "не применим", "не требуется", "отсутствуют" → `:::empty-section` |
| FR-09.2 | Раздел без содержимого (только заголовок) → `:::empty-section` |

### FR-10: Режим сравнения (diff)

| ID | Требование |
|----|------------|
| FR-10.1 | При указании исходного .md файла — показать различия |
| FR-10.2 | Поддержка вывода в формате unified diff |
| FR-10.3 | Опция "только изменённые секции" |
| FR-10.4 | Цветной вывод в терминале (опционально) |

---

## Нефункциональные требования

### NFR-01: Совместимость

| ID | Требование |
|----|------------|
| NFR-01.1 | Поддержка DOCX, созданных Microsoft Word 2016+ |
| NFR-01.2 | Поддержка DOCX, созданных LibreOffice Writer 7.0+ |
| NFR-01.3 | Поддержка документов, сгенерированных нашим конвертером (round-trip) |
| NFR-01.4 | Поддержка DOCX с включённым режимом отслеживания изменений (Track Changes) |

### NFR-02: Производительность

| ID | Требование |
|----|------------|
| NFR-02.1 | Конвертация документа до 50 страниц — менее 5 секунд |
| NFR-02.2 | Конвертация документа до 200 страниц — менее 20 секунд |
| NFR-02.3 | Потребление памяти — не более 256 МБ для документов до 50 страниц |
| NFR-02.4 | Потребление памяти — не более 512 МБ для документов до 200 страниц |

### NFR-03: Качество распознавания

| ID | Требование |
|----|------------|
| NFR-03.1 | Точность распознавания структуры — не менее 99% для документов, созданных нашим конвертером |
| NFR-03.2 | Точность для внешних документов (стандартная структура) — не менее 90% |
| NFR-03.3 | Точность для произвольных документов — не менее 70% (с логированием проблем) |

### NFR-04: Устойчивость к ошибкам

| ID | Требование |
|----|------------|
| NFR-04.1 | При ошибке парсинга отдельного элемента — продолжать обработку |
| NFR-04.2 | Логирование всех нераспознанных элементов с указанием позиции |
| NFR-04.3 | Выдача предупреждений о потенциальных проблемах |
| NFR-04.4 | Корректная обработка повреждённых DOCX (с информативной ошибкой) |
| NFR-04.5 | Нераспознанные элементы сохраняются как HTML-комментарии `<!-- UNRECOGNIZED: ... -->` |

### NFR-05: CLI-интерфейс

**Основная команда:**
```bash
chtz-converter reverse <input.docx> [options]
```

**Опции:**

| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `-o, --output <file>` | Выходной .md файл | `<input>.md` |
| `--images-dir <dir>` | Папка для изображений | `images/` |
| `--diff <original.md>` | Сравнить с оригиналом | — |
| `--strict` | Строгая валидация структуры | `false` |
| `--no-images` | Не извлекать изображения | `false` |
| `--verbose` | Подробный вывод | `false` |
| `--format <fmt>` | Формат вывода: `md`, `json` | `md` |

**Примеры:**

```bash
# Базовая конвертация
chtz-converter reverse document.docx -o output.md

# С указанием папки для изображений
chtz-converter reverse document.docx -o output.md --images-dir assets/

# Сравнение с оригиналом
chtz-converter reverse edited.docx --diff original.md

# Строгий режим с подробным выводом
chtz-converter reverse document.docx --strict --verbose
```

### NFR-06: Расширяемость

| ID | Требование |
|----|------------|
| NFR-06.1 | Модульная архитектура с отдельными парсерами для разных типов элементов |
| NFR-06.2 | Возможность добавления новых типов таблиц через плагины |
| NFR-06.3 | Конфигурационный файл для кастомизации правил распознавания |
| NFR-06.4 | API для программного использования (не только CLI) |

**Пример конфигурации:**

```json
{
  "tableRecognition": {
    "terms": {
      "headers": ["Термин", "Определение"],
      "directive": ":::terms"
    },
    "custom": {
      "headers": ["Поле 1", "Поле 2"],
      "directive": ":::custom-table"
    }
  },
  "sectionMapping": {
    "1. Термины": "# 1. Термины и определения"
  }
}
```

### NFR-07: Документация

| ID | Требование |
|----|------------|
| NFR-07.1 | README с описанием установки и базового использования |
| NFR-07.2 | Описание алгоритма распознавания |
| NFR-07.3 | Примеры для типовых сценариев |
| NFR-07.4 | Список известных ограничений |
| NFR-07.5 | Troubleshooting guide для типичных проблем |

---

## Сценарии использования

### UC-01: Конвертация исторического документа

**Цель:** Перевести существующий ЧТЗ в Markdown для версионирования в Git.

**Шаги:**
1. Пользователь запускает команду:
   ```bash
   chtz-converter reverse legacy-chtz.docx -o specs/legacy-chtz.md --verbose
   ```
2. Система парсит DOCX и извлекает структуру
3. Система выводит предупреждения о нераспознанных элементах
4. Система сохраняет результат в `specs/legacy-chtz.md`
5. Система извлекает изображения в `specs/images/`
6. Пользователь проверяет результат и вносит правки при необходимости

### UC-02: Синхронизация после внешнего редактирования

**Цель:** Получить изменения, внесённые внешним пользователем в DOCX.

**Шаги:**
1. Внешний пользователь редактирует `document.docx`
2. Пользователь запускает:
   ```bash
   chtz-converter reverse document.docx --diff original.md
   ```
3. Система показывает различия между оригиналом и отредактированной версией
4. Пользователь принимает решение:
   - Применить все изменения: `chtz-converter reverse document.docx -o original.md`
   - Применить выборочно: вручную перенести нужные изменения

### UC-03: Валидация round-trip

**Цель:** Проверить, что конвертация Markdown → DOCX → Markdown не теряет данные.

**Шаги:**
1. Пользователь запускает:
   ```bash
   # Прямая конвертация
   chtz-converter build original.md -o test.docx

   # Обратная конвертация
   chtz-converter reverse test.docx -o roundtrip.md

   # Сравнение
   diff original.md roundtrip.md
   ```
2. При отсутствии различий — round-trip успешен
3. При наличии различий — анализ и исправление конвертера

### UC-04: Пакетная конвертация

**Цель:** Конвертировать несколько документов одной командой.

**Шаги:**
1. Пользователь запускает:
   ```bash
   for file in docs/*.docx; do
     chtz-converter reverse "$file" -o "md/$(basename "$file" .docx).md"
   done
   ```
2. Система последовательно обрабатывает все файлы
3. Система выводит итоговый отчёт

---

## Архитектура (высокоуровневая)

```
┌─────────────────────────────────────────────────────────────┐
│                      CLI Interface                          │
│                  (commander / yargs)                        │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                    Reverse Converter                         │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ DOCX Parser  │  │  Recognizers │  │  MD Builder  │       │
│  │  (JSZip +    │  │              │  │              │       │
│  │   xml2js)    │  │ - Metadata   │  │ - YAML       │       │
│  │              │  │ - Tables     │  │ - Sections   │       │
│  │              │  │ - Sections   │  │ - Directives │       │
│  │              │  │ - Images     │  │ - Content    │       │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘       │
│         │                 │                 │               │
│         └────────────────►├─────────────────►               │
│                           │                                 │
└───────────────────────────┼─────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────┐
│                      Output                                  │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  .md file    │  │   images/    │  │  diff output │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

---

## Известные ограничения

1. **Track Changes** — режим отслеживания изменений поддерживается частично (только принятые изменения)
2. **Сложные таблицы** — объединённые ячейки могут распознаваться некорректно
3. **Формулы** — математические формулы (OMML) не поддерживаются
4. **Комментарии** — комментарии Word игнорируются
5. **Колонтитулы** — содержимое колонтитулов не извлекается
6. **Сноски** — сноски не поддерживаются

---

## Зависимости

- `jszip` — распаковка DOCX
- `xml2js` или `fast-xml-parser` — парсинг XML
- `js-yaml` — генерация YAML
- `chalk` — цветной вывод в терминале
- `commander` — CLI-интерфейс
- `diff` — сравнение текстов

---

## Версионирование

| Версия | Описание |
|--------|----------|
| 0.1.0 | MVP: базовый парсинг, распознавание структуры |
| 0.2.0 | Распознавание специальных таблиц |
| 0.3.0 | Извлечение изображений |
| 0.4.0 | Режим сравнения (diff) |
| 1.0.0 | Полная функциональность, стабильный API |
