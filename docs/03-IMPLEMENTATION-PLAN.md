# План реализации CHTZ Generator

## Обзор этапов

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          ПЛАН РЕАЛИЗАЦИИ                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Этап 1: Подготовка (30 мин)                                            │
│  ════════════════════════════                                            │
│  ☐ Инициализация проекта                                                │
│  ☐ Установка зависимостей                                               │
│  ☐ Подготовка шаблона                                                   │
│                                                                          │
│  Этап 2: Parser Module (1 час)                                          │
│  ═════════════════════════════                                           │
│  ☐ YAML Parser                                                          │
│  ☐ Markdown Parser                                                      │
│  ☐ Directive Processor                                                  │
│                                                                          │
│  Этап 3: Builder Module (2 часа)                                        │
│  ════════════════════════════════                                        │
│  ☐ XML утилиты                                                          │
│  ☐ Content Builder (текст, списки)                                      │
│  ☐ Table Builder                                                        │
│  ☐ Meta Builder (шапка)                                                 │
│  ☐ Function Table Builder                                               │
│  ☐ Image Builder                                                        │
│  ☐ Document Builder                                                     │
│                                                                          │
│  Этап 4: Assembler Module (1 час)                                       │
│  ═════════════════════════════════                                       │
│  ☐ Template Handler                                                     │
│  ☐ Relationships Manager                                                │
│  ☐ Package Creator                                                      │
│                                                                          │
│  Этап 5: CLI и интеграция (30 мин)                                      │
│  ══════════════════════════════════                                      │
│  ☐ CLI интерфейс                                                        │
│  ☐ Интеграция модулей                                                   │
│  ☐ Обработка ошибок                                                     │
│                                                                          │
│  Этап 6: Тестирование (1 час)                                           │
│  ════════════════════════════                                            │
│  ☐ Создание тестового документа                                         │
│  ☐ Генерация и проверка                                                 │
│  ☐ Исправление багов                                                    │
│                                                                          │
│  Этап 7: Документация (1 час)                                           │
│  ════════════════════════════                                            │
│  ☐ User Guide                                                           │
│  ☐ Markdown Reference                                                   │
│  ☐ AI Prompt                                                            │
│                                                                          │
│  ИТОГО: ~7 часов                                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Этап 1: Подготовка

### Задача 1.1: Инициализация проекта

```bash
# Структура директорий
mkdir -p chtz-generator/{src/{parser,builders,assembler,utils,styles},bin,templates,examples,tests,docs}

# Инициализация npm
cd chtz-generator
npm init -y
```

**Результат**: Базовая структура проекта

### Задача 1.2: Установка зависимостей

```bash
npm install unified remark-parse remark-gfm remark-directive gray-matter adm-zip commander chalk
npm install -D jest
```

**Результат**: Установлены все необходимые пакеты

### Задача 1.3: Подготовка шаблона

- Очистить оригинальный документ
- Оставить только стили, колонтитулы, нумерацию
- Сохранить как `templates/gpn-template.docx`

**Результат**: Чистый шаблон готов к использованию

---

## Этап 2: Parser Module

### Задача 2.1: YAML Parser

**Файл**: `src/parser/yaml-parser.js`

**Функционал**:
- Извлечение YAML front matter с помощью `gray-matter`
- Валидация обязательных полей
- Преобразование типов (даты, булевы значения)

**Тесты**:
- Парсинг корректного YAML
- Обработка отсутствующих полей
- Обработка некорректного YAML

### Задача 2.2: Markdown Parser

**Файл**: `src/parser/md-parser.js`

**Функционал**:
- Парсинг Markdown в AST с помощью unified/remark
- Поддержка GFM-таблиц
- Поддержка директив

**Тесты**:
- Парсинг заголовков
- Парсинг списков (вложенных)
- Парсинг таблиц

### Задача 2.3: Directive Processor

**Файл**: `src/parser/directives.js`

**Функционал**:
- Обработка `:::terms`
- Обработка `:::function-table`
- Обработка `:::changes-table`
- Обработка `:::note`
- Обработка `:::empty-section`

**Тесты**:
- Каждый тип директивы
- Директива с атрибутами
- Вложенный контент

---

## Этап 3: Builder Module

### Задача 3.1: XML утилиты

**Файл**: `src/utils/xml-utils.js`

**Функционал**:
```javascript
// Экранирование XML
escapeXml(text)

// Создание XML тега
tag(name, attrs, content)

// Создание текстового элемента Word
textRun(text, options)

// Создание параграфа
paragraph(runs, options)
```

### Задача 3.2: Content Builder

**Файл**: `src/builders/content-builder.js`

**Функционал**:
- Генерация `<w:p>` для параграфов
- Генерация `<w:r>` для текста с форматированием
- Генерация списков с `<w:numPr>`
- Генерация гиперссылок

**Приоритет элементов**:
1. Параграфы
2. Жирный/курсив текст
3. Маркированные списки
4. Нумерованные списки
5. Гиперссылки

### Задача 3.3: Table Builder

**Файл**: `src/builders/table-builder.js`

**Функционал**:
- Создание `<w:tbl>` с настройками
- Создание строк `<w:tr>`
- Создание ячеек `<w:tc>` с параметрами
- Поддержка заголовков таблиц

### Задача 3.4: Meta Builder

**Файл**: `src/builders/meta-builder.js`

**Функционал**:
- Генерация таблицы шапки документа
- Заполнение из metadata
- Генерация таблицы истории
- Генерация таблицы связанных документов

### Задача 3.5: Function Table Builder

**Файл**: `src/builders/function-table-builder.js`

**Функционал**:
- Структура функциональной таблицы
- Ссылка на задачу (гиперссылка)
- Рекурсивная генерация контента сценария

### Задача 3.6: Image Builder

**Файл**: `src/builders/image-builder.js`

**Функционал**:
- Чтение изображения
- Определение размеров
- Генерация `<w:drawing>`
- Регистрация relationship

### Задача 3.7: Document Builder

**Файл**: `src/builders/document-builder.js`

**Функционал**:
- Сборка полного document.xml
- Правильный порядок секций
- Добавление sectPr с колонтитулами

---

## Этап 4: Assembler Module

### Задача 4.1: Template Handler

**Файл**: `src/assembler/template-handler.js`

**Функционал**:
- Распаковка шаблона (AdmZip)
- Извлечение стилей
- Работа с временной директорией

### Задача 4.2: Relationships Manager

**Файл**: `src/assembler/relationships.js`

**Функционал**:
- Парсинг существующих relationships
- Добавление новых (изображения, ссылки)
- Генерация уникальных rId
- Генерация XML

### Задача 4.3: Package Creator

**Файл**: `src/assembler/index.js`

**Функционал**:
- Координация всего процесса
- Копирование файлов
- Сборка ZIP
- Очистка временных файлов

---

## Этап 5: CLI и интеграция

### Задача 5.1: CLI интерфейс

**Файл**: `bin/chtz-generate.js`

**Функционал**:
- Парсинг аргументов (commander)
- Цветной вывод (chalk)
- Прогресс-бар (опционально)

### Задача 5.2: Главный модуль

**Файл**: `src/index.js`

**Функционал**:
```javascript
async function generate(inputPath, options) {
  // 1. Читаем файл
  // 2. Парсим YAML + Markdown
  // 3. Подготавливаем шаблон
  // 4. Строим document.xml
  // 5. Собираем docx
  // 6. Сохраняем результат
}
```

### Задача 5.3: Обработка ошибок

**Файл**: `src/utils/errors.js`

**Функционал**:
- Класс ChtzError с кодом и контекстом
- Форматирование сообщений
- Цветной вывод ошибок

---

## Этап 6: Тестирование

### Задача 6.1: Тестовый документ

Создать `examples/full/document.md` со всеми элементами:
- YAML front matter
- Заголовки всех уровней
- Все типы списков
- Таблицы
- Все директивы
- Изображения
- Ссылки

### Задача 6.2: Генерация и проверка

- Запустить генератор
- Открыть результат в Word
- Сравнить с оригиналом
- Проверить все элементы

### Задача 6.3: Исправление багов

- Фиксить найденные проблемы
- Повторять тестирование

---

## Этап 7: Документация

### Задача 7.1: User Guide

**Файл**: `docs/04-USER-GUIDE.md`

Содержание:
- Установка
- Быстрый старт
- Примеры использования
- Troubleshooting

### Задача 7.2: Markdown Reference

**Файл**: `docs/05-MARKDOWN-REFERENCE.md`

Содержание:
- Полный синтаксис
- Все директивы
- Примеры каждого элемента

### Задача 7.3: AI Prompt

**Файл**: `docs/06-AI-PROMPT.md`

Содержание:
- Системный промпт
- Инструкции для модели
- Примеры генерации

---

## Чеклист готовности

### Минимальный функционал (MVP)

- [ ] Парсинг YAML метаданных
- [ ] Парсинг базового Markdown (заголовки, параграфы, списки)
- [ ] Генерация шапки документа
- [ ] Генерация таблицы терминов
- [ ] Генерация функциональных таблиц
- [ ] Сборка docx с шаблоном
- [ ] CLI интерфейс

### Полный функционал

- [ ] Все типы директив
- [ ] Изображения с размерами
- [ ] Перекрёстные ссылки
- [ ] Таблица "как есть/как будет"
- [ ] История изменений
- [ ] Связанные документы
- [ ] Валидация с понятными ошибками
- [ ] Документация

---

## Порядок реализации файлов

```
1.  src/utils/xml-utils.js         # Базовые XML утилиты
2.  src/styles/gpn-styles.js       # Конфигурация стилей
3.  src/parser/yaml-parser.js      # Парсинг YAML
4.  src/parser/directives.js       # Обработка директив
5.  src/parser/md-parser.js        # Парсинг Markdown
6.  src/parser/index.js            # Экспорт парсера
7.  src/builders/content-builder.js # Контент
8.  src/builders/table-builder.js   # Таблицы
9.  src/builders/meta-builder.js    # Шапка
10. src/builders/terms-builder.js   # Термины
11. src/builders/function-table-builder.js # Функц. таблицы
12. src/builders/changes-builder.js # Как есть/как будет
13. src/builders/image-builder.js   # Изображения
14. src/builders/document-builder.js # Сборка document.xml
15. src/builders/index.js           # Экспорт билдеров
16. src/assembler/relationships.js  # Управление связями
17. src/assembler/template-handler.js # Работа с шаблоном
18. src/assembler/index.js          # Сборка docx
19. src/index.js                    # Главный модуль
20. bin/chtz-generate.js            # CLI
```

---

## Начинаем реализацию

Следующий шаг: создание базовых файлов проекта и реализация первых модулей.
